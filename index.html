<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素跳跃大冒险 - Six Levels</title>
    <style>
        /* ------------------------------------- */
        /* 1. CSS样式：让游戏居中显示并设置像素风字体 */
        /* ------------------------------------- */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #333; /* 暗色背景 */
            font-family: monospace, sans-serif; /* 简单的像素风格字体 */
            color: white;
            flex-direction: column;
        }

        /* 游戏容器，用于放置画布和界面元素 */
        #game-container {
            border: 4px solid #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            position: relative;
        }

        /* 游戏画布 - 核心渲染区域 */
        #game-canvas {
            display: block; /* 移除画布底部的额外间隙 */
            image-rendering: pixelated; /* 确保像素风格清晰 */
        }

        /* 游戏信息面板/开始界面 */
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }

        #info-panel h1 {
            color: yellow;
            font-size: 2.5em;
            text-shadow: 2px 2px #000;
        }

        #start-button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 20px;
            background-color: green;
            color: white;
            border: 2px solid white;
            transition: background-color 0.3s;
        }
        #start-button:hover {
            background-color: darkgreen;
        }

        #share-url {
            margin-top: 20px;
            font-size: 0.9em;
            padding: 10px;
            background: #222;
            border: 1px solid #555;
            word-break: break-all;
        }

        #share-url input {
            width: 90%;
            padding: 5px;
            margin-top: 5px;
            border: none;
            background: #444;
            color: white;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="game-canvas" width="640" height="480"></canvas>

        <div id="info-panel">
            <h1>像素跳跃大冒险</h1>
            <p>操作：方向键/WASD移动，空格/上键跳跃。</p>
            <p>目标：收集金币，躲避障碍，找到出口！</p>
            <p>当前关卡: <span id="current-level-display">1 / 6</span></p>
            <button id="start-button">开始游戏</button>
            <div id="share-url">分享链接: (游戏开始后，您的专属分享链接将在此生成)</div>
        </div>
    </div>

    <p>得分: <span id="score-display">0</span> | 生命: <span id="life-display">3</span></p>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;

        // --- 游戏配置 ---
        const TILE_SIZE = 32; // 像素风格瓦片大小
        const GRAVITY = 0.6;
        const JUMP_POWER = -12;
        const PLAYER_SPEED = 5;
        let gameState = 'START'; // START | PLAYING | PAUSED | GAMEOVER | WIN

        // --- 游戏对象状态 ---
        let player = {
            x: 50,
            y: 50,
            width: TILE_SIZE,
            height: TILE_SIZE * 1.5,
            velX: 0,
            velY: 0,
            onGround: false,
            score: 0,
            lives: 3,
            canDoubleJump: false, // 道具效果
            usedDoubleJump: false
        };

        // 基础关卡数据 (包含6个关卡，玩法逐渐复杂)
        const levels = [
            // Level 1: 简单的平台和金币
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE }, // 地面
                { type: 'platform', x: 200, y: 350, width: 100, height: TILE_SIZE },
                { type: 'coin', x: 250, y: 300, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'coin', x: 100, y: 416, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'exit', x: 600, y: 448 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ],
            // Level 2: 尖刺和二段跳道具
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE },
                { type: 'platform', x: 400, y: 300, width: 100, height: TILE_SIZE },
                { type: 'spike', x: 100, y: 448 - 16, width: TILE_SIZE * 2, height: 16 }, // 尖刺 (在地面上)
                { type: 'spike', x: 500, y: 448 - 16, width: TILE_SIZE, height: 16 }, 
                { type: 'powerup_doublejump', x: 430, y: 250, width: TILE_SIZE, height: TILE_SIZE }, // 二段跳道具
                { type: 'exit', x: 50, y: 448 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ],
            // Level 3: 移动平台和简单敌人
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE },
                { type: 'platform_moving', x: 100, y: 300, width: 100, height: TILE_SIZE, startX: 100, endX: 350, speed: 1.5 }, // 移动平台
                { type: 'enemy_walker', x: 450, y: 448 - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, speed: 1, range: 100, startX: 450 }, // 移动敌人
                { type: 'coin', x: 200, y: 250, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'exit', x: 600, y: 448 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ],
            // Level 4: 垂直平台跳跃 (平台更高)
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE },
                { type: 'platform', x: 50, y: 380, width: 80, height: TILE_SIZE },
                { type: 'platform', x: 150, y: 310, width: 80, height: TILE_SIZE },
                { type: 'platform', x: 250, y: 240, width: 80, height: TILE_SIZE },
                { type: 'spike', x: 350, y: 448 - 16, width: TILE_SIZE * 2, height: 16 }, 
                { type: 'enemy_walker', x: 400, y: 240 - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, speed: 0.8, range: 50, startX: 400 },
                { type: 'coin', x: 280, y: 190, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'exit', x: 550, y: 448 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ],
            // Level 5: 更多敌人和陷阱
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE },
                { type: 'enemy_walker', x: 50, y: 448 - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, speed: 1.5, range: 50, startX: 50 },
                { type: 'spike', x: 200, y: 448 - 16, width: TILE_SIZE, height: 16 },
                { type: 'platform', x: 300, y: 350, width: 150, height: TILE_SIZE },
                { type: 'enemy_walker', x: 350, y: 350 - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, speed: 1.2, range: 40, startX: 350 },
                { type: 'coin', x: 380, y: 300, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'exit', x: 600, y: 448 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ],
            // Level 6: 最终挑战
            [
                { type: 'platform', x: 0, y: 448, width: 640, height: TILE_SIZE },
                { type: 'platform_moving', x: 50, y: 350, width: 80, height: TILE_SIZE, startX: 50, endX: 250, speed: 2 },
                { type: 'platform_moving', x: 350, y: 250, width: 80, height: TILE_SIZE, startX: 350, endX: 550, speed: 2 },
                { type: 'spike', x: 280, y: 448 - 16, width: TILE_SIZE * 3, height: 16 }, 
                { type: 'coin', x: 500, y: 200, width: TILE_SIZE, height: TILE_SIZE },
                { type: 'exit', x: 60, y: 200 - 64, width: TILE_SIZE, height: TILE_SIZE * 2 }
            ]
        ];
        let currentLevelIndex = 0;
        let currentLevel = levels[currentLevelIndex];
        
        // -------------------------------------
        // 3. 事件监听 (输入处理)
        // -------------------------------------
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true; // 统一转小写处理 WASD
            // 阻止空格键触发页面滚动
            if (e.key === ' ' && gameState === 'PLAYING') {
                e.preventDefault();
            }
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // -------------------------------------
        // 4. 辅助函数
        // -------------------------------------

        // 简单的AABB碰撞检测
        function checkCollision(objA, objB) {
            return (
                objA.x < objB.x + objB.width &&
                objA.x + objA.width > objB.x &&
                objA.y < objB.y + objB.height &&
                objA.y + objA.height > objB.y
            );
        }

        // -------------------------------------
        // 5. 游戏逻辑函数
        // -------------------------------------

        // 渲染函数
        function draw() {
            // 清除画布
            ctx.fillStyle = '#1e90ff'; // 天空蓝
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            // 绘制当前关卡元素
            currentLevel.forEach(obj => {
                // 绘制平台和移动平台
                if (obj.type.startsWith('platform')) {
                    ctx.fillStyle = '#654321'; // 棕色
                    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                } 
                // 绘制金币
                else if (obj.type === 'coin') {
                    ctx.fillStyle = 'yellow';
                    ctx.beginPath();
                    ctx.arc(obj.x + TILE_SIZE / 2, obj.y + TILE_SIZE / 2, TILE_SIZE / 4, 0, Math.PI * 2);
                    ctx.fill();
                } 
                // 绘制出口
                else if (obj.type === 'exit') {
                    ctx.fillStyle = 'lime'; // 绿色出口
                    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                }
                // 绘制尖刺
                else if (obj.type === 'spike') {
                    ctx.fillStyle = '#999'; // 灰色尖刺
                    ctx.beginPath();
                    // 假设尖刺底部在 obj.y + obj.height
                    ctx.moveTo(obj.x, obj.y + obj.height);
                    ctx.lineTo(obj.x + obj.width / 2, obj.y);
                    ctx.lineTo(obj.x + obj.width, obj.y + obj.height);
                    ctx.closePath();
                    ctx.fill();
                } 
                // 绘制二段跳道具
                else if (obj.type === 'powerup_doublejump') {
                    ctx.fillStyle = 'cyan'; // 青色道具
                    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                    ctx.fillStyle = 'black';
                    ctx.font = '10px monospace';
                    ctx.fillText('DJ', obj.x + 8, obj.y + 20); 
                }
                // 绘制敌人
                else if (obj.type === 'enemy_walker') {
                    ctx.fillStyle = 'purple'; // 紫色敌人
                    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                }
            });

            // 绘制玩家
            ctx.fillStyle = 'red'; // 红色玩家
            ctx.fillRect(player.x, player.y, player.width, player.height);
        }

        // 更新函数
        function update() {
            if (gameState !== 'PLAYING') return;

            // --- 移动平台逻辑 ---
            currentLevel.forEach(obj => {
                if (obj.type === 'platform_moving') {
                    if (!obj.direction) obj.direction = 1; // 1: 右移, -1: 左移
                    
                    const oldX = obj.x;
                    obj.x += obj.speed * obj.direction;

                    // 边界反转
                    if (obj.x >= obj.endX) {
                        obj.direction = -1;
                    } else if (obj.x <= obj.startX) {
                        obj.direction = 1;
                    }

                    // 玩家随平台移动 (简单实现)
                    if (player.onGround && player.x + player.width > oldX && player.x < oldX + obj.width && player.y + player.height === obj.y) {
                        player.x += obj.x - oldX;
                    }
                }
            });

            // --- 敌人移动逻辑 ---
            currentLevel.forEach(obj => {
                if (obj.type === 'enemy_walker') {
                    if (!obj.direction) obj.direction = 1; 

                    obj.x += obj.speed * obj.direction;

                    // 范围限制
                    if (obj.x >= obj.startX + obj.range) {
                        obj.direction = -1;
                    } else if (obj.x <= obj.startX) { // 敌人回到起始点 (简化逻辑)
                        obj.direction = 1;
                    }
                }
            });
            
            // --- 玩家输入和水平移动 ---
            player.velX = 0;
            if (keys['arrowleft'] || keys['a']) {
                player.velX = -PLAYER_SPEED;
            }
            if (keys['arrowright'] || keys['d']) {
                player.velX = PLAYER_SPEED;
            }

            // --- 重力和垂直移动 ---
            player.velY += GRAVITY;
            if (player.velY > 15) player.velY = 15;

            // 跳跃/二段跳
            if (keys['arrowup'] || keys['w'] || keys[' ']) {
                if (player.onGround) {
                    player.velY = JUMP_POWER;
                    player.onGround = false;
                    player.usedDoubleJump = false; // 重置二段跳使用状态
                } else if (player.canDoubleJump && !player.usedDoubleJump) {
                    player.velY = JUMP_POWER * 0.8; // 二段跳稍弱
                    player.usedDoubleJump = true;
                }
                keys[' '] = false; // 消费跳跃输入，避免持续按住一直跳
                keys['arrowup'] = false; 
                keys['w'] = false;
            }

            // 更新位置
            player.x += player.velX;
            
            // 边界检查 (X轴)
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > GAME_WIDTH) player.x = GAME_WIDTH - player.width;

            // 更新位置 (Y轴)
            player.y += player.velY;
            player.onGround = false;

            // -----------------------------------------------------
            // 平台碰撞检测 (Y轴)
            // -----------------------------------------------------
            currentLevel.forEach(obj => {
                if (obj.type.startsWith('platform')) {
                    if (checkCollision(player, obj)) {
                        // 如果是从上方落下
                        if (player.velY > 0 && player.y + player.height - player.velY <= obj.y) {
                            player.y = obj.y - player.height;
                            player.velY = 0;
                            player.onGround = true;
                            player.usedDoubleJump = false; // 接触地面重置二段跳
                        }
                        // 如果是从下方撞到平台
                        else if (player.velY < 0 && player.y - player.velY >= obj.y + obj.height) {
                            player.y = obj.y + obj.height;
                            player.velY = 0;
                        }
                    }
                }
            });

            // -----------------------------------------------------
            // 收集/伤害/过关 碰撞检测
            // -----------------------------------------------------
            let nextLevel = false; 

            currentLevel = currentLevel.filter(obj => {
                if (checkCollision(player, obj)) {
                    if (obj.type === 'coin') {
                        player.score += 10;
                        return false; // 移除金币
                    } 
                    else if (obj.type === 'powerup_doublejump') {
                        player.canDoubleJump = true;
                        alert("获得二段跳能力！");
                        return false; // 移除道具
                    }
                    else if (obj.type === 'spike' || obj.type === 'enemy_walker') {
                        // 伤害/死亡
                        player.lives--;
                        resetPlayer(); 
                        return true; // 伤害性物体不移除
                    }
                    else if (obj.type === 'exit') {
                        nextLevel = true; // 准备进入下一关
                        return true; // 出口不移除
                    }
                }
                return true; // 其他物体保留
            });

            // 边界检查 (Y轴) - 掉出屏幕即死亡
            if (player.y > GAME_HEIGHT) {
                player.lives--;
                resetPlayer();
            }

            // -----------------------------------------------------
            // 关卡切换逻辑
            // -----------------------------------------------------
            if (nextLevel) {
                if (currentLevelIndex < levels.length - 1) {
                    currentLevelIndex++;
                    currentLevel = levels[currentLevelIndex];
                    resetPlayer(); 
                    player.canDoubleJump = false; // 道具状态在新关卡重置
                    player.usedDoubleJump = false;
                } else {
                    // 恭喜通关！
                    gameState = 'WIN';
                    document.getElementById('info-panel').style.display = 'flex';
                    document.getElementById('info-panel').innerHTML = '<h1>恭喜！通关！</h1><p>最终得分: ' + player.score + '</p><button onclick="resetGame()">重新开始</button>';
                }
            }

            // 检查游戏结束/胜利条件
            if (player.lives <= 0) {
                gameState = 'GAMEOVER';
                document.getElementById('info-panel').style.display = 'flex';
                document.getElementById('info-panel').innerHTML = '<h1>游戏结束!</h1><p>得分: ' + player.score + '</p><button onclick="resetGame()">重新开始</button>';
            }

            // 更新HUD
            updateHUD();
        }

        // 重置玩家状态（死亡/掉落后或进入新关卡）
        function resetPlayer() {
            // 简单地重置到起点附近
            player.x = 50;
            player.y = 50;
            player.velX = 0;
            player.velY = 0;
            player.onGround = false;
            player.usedDoubleJump = false; // 重置二段跳的使用
        }

        // 更新屏幕上的得分和生命显示
        function updateHUD() {
            document.getElementById('score-display').textContent = player.score;
            document.getElementById('life-display').textContent = player.lives;
            document.getElementById('current-level-display').textContent = (currentLevelIndex + 1) + ' / 6';
        }

        // 游戏主循环
        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        // -------------------------------------
        // 6. 网址分享功能实现
        // -------------------------------------

        /**
         * 编码游戏状态到URL参数 (Level, Score, Lives, DoubleJumpStatus)
         */
        function encodeGameState() {
            // 0/1 表示 boolean 状态
            const dj = player.canDoubleJump ? 1 : 0; 
            return `l=${currentLevelIndex + 1}&s=${player.score}&li=${player.lives}&dj=${dj}`;
        }

        /**
         * 从URL参数解码游戏状态
         */
        function decodeGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const level = parseInt(urlParams.get('l'));
            const score = parseInt(urlParams.get('s'));
            const lives = parseInt(urlParams.get('li'));
            const dj = parseInt(urlParams.get('dj'));

            if (level && level >= 1 && level <= levels.length) {
                currentLevelIndex = level - 1;
                currentLevel = levels[currentLevelIndex];
                resetPlayer();
            }
            if (!isNaN(score)) {
                player.score = score;
            }
            if (!isNaN(lives)) {
                player.lives = lives;
            }
            if (!isNaN(dj)) {
                player.canDoubleJump = (dj === 1);
            }
        }

        // 启动游戏
        function startGame() {
            document.getElementById('info-panel').style.display = 'none';
            gameState = 'PLAYING';
            
            // 实时更新分享链接，包含当前游戏进度
            const baseUrl = window.location.href.split('?')[0]; // 获取基础URL
            const shareUrl = `${baseUrl}?${encodeGameState()}`;
            document.getElementById('share-url').innerHTML = `分享链接 (复制): <input type="text" value="${shareUrl}" readonly onclick="this.select()">`;
            
            updateHUD();
        }

        function resetGame() {
            currentLevelIndex = 0;
            currentLevel = levels[currentLevelIndex];
            player.score = 0;
            player.lives = 3;
            player.canDoubleJump = false;
            player.usedDoubleJump = false;
            resetPlayer();
            
            // 重新设置信息面板
            document.getElementById('info-panel').style.display = 'flex';
            document.getElementById('info-panel').innerHTML = '<h1>像素跳跃大冒险</h1><p>操作：方向键/WASD移动，空格/上键跳跃。</p><p>目标：收集金币，躲避障碍，找到出口！</p><p>当前关卡: <span id="current-level-display">1 / 6</span></p><button id="start-button">开始游戏</button><div id="share-url">分享链接: (游戏开始后，您的专属分享链接将在此生成)</div>';
            document.getElementById('start-button').addEventListener('click', startGame);

            gameState = 'START';
            updateHUD();
        }

        // --- 初始化流程 ---
        decodeGameState(); // 尝试从URL加载进度
        document.getElementById('start-button').addEventListener('click', startGame);

        // 启动游戏循环
        loop();
    </script>

</body>
</html>
