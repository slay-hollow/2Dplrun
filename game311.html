<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ç®±å­å¤§å¸ˆ - ç¨³å®šç‰ˆ</title>
    <style>
        /* --- æ•´ä½“å¸ƒå±€ --- */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a2e; /* æ·±å¤ªç©ºè“ */
            color: #e9e9e9;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            user-select: none; /* ç¦ç”¨æ–‡æœ¬é€‰æ‹© */
        }
        h1 {
            color: #ffcc00;
            font-size: 2.5em;
        }

        /* --- æ¸¸æˆå®¹å™¨å’Œåœ°å›¾ç½‘æ ¼ (æ ¸å¿ƒæ¸²æŸ“åŒº) --- */
        #game-grid {
            display: grid;
            /* 16x16 ç½‘æ ¼ï¼Œæ¯æ ¼ 40px */
            grid-template-columns: repeat(16, 40px);
            grid-template-rows: repeat(16, 40px);
            width: 640px; 
            height: 640px;
            border: 4px solid #00aaff;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.8);
            position: relative;
            background-color: #333344;
        }
        /* éšè—ä¿¡æ¯é¢æ¿ï¼Œè®©å®ƒæµ®åœ¨æ¸¸æˆåŒºä¸Šæ–¹ */
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
        }

        /* --- åœ°å›¾ç“¦ç‰‡æ ·å¼ --- */
        .tile {
            width: 40px;
            height: 40px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        .wall {
            background-color: #5b5530; 
            border: 2px solid #a19555;
        }
        .target {
            background-color: #444; 
            color: #ff6f61;
        }
        
        /* --- åŠ¨æ€å…ƒç´ å®¹å™¨ --- */
        #dynamic-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢çš„ grid */
        }
        .element {
            position: absolute;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            transition: transform 0.15s ease-out; /* å¹³æ»‘ç§»åŠ¨åŠ¨ç”» */
            pointer-events: none;
        }
        .player {
            background-color: #3498db;
            border-radius: 50%;
            color: #fff;
            z-index: 5;
        }
        .box {
            background-color: #f39c12;
            border: 3px solid #e67e22;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            color: #000;
            z-index: 4;
        }
        .box-on-target {
            background-color: #2ecc71; /* ç»¿è‰²è¡¨ç¤ºåˆ°ä½ */
            border-color: #27ae60;
        }

        /* --- å¤´éƒ¨æ˜¾ç¤ºåŒº (HUD) --- */
        .control-button {
            padding: 8px 15px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
            background-color: #ff6f61; 
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .control-button:disabled {
            background-color: #4a4a4a;
            cursor: default;
        }
        .control-button:hover:not(:disabled) {
            background-color: #e55a5a;
        }
        #hud {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #333344;
            border-radius: 8px;
        }
        .hud-item strong {
            color: #00aaff;
        }
    </style>
</head>
<body>

    <h1>ğŸ“¦ æ¨ç®±å­å¤§å¸ˆ - ç¨³å®šç‰ˆ</h1>

    <div id="game-container">
        <div id="game-grid"></div>

        <div id="dynamic-elements">
            <div id="player-element" class="element player">ğŸƒ</div>
        </div>

        <div id="info-panel">
            <h1>æ¨ç®±å­å¤§å¸ˆ</h1>
            <p>æ“ä½œï¼šæ–¹å‘é”®/WASD ç§»åŠ¨ã€‚</p>
            <p><strong>R</strong>: é‡ç½®å…³å¡ | <strong>Z</strong>: æ‚”æ£‹ (Undo)</p>
            <p>ç›®æ ‡ï¼šå°†æ‰€æœ‰ç®±å­æ¨åˆ°ç›®æ ‡ç‚¹ä¸Šã€‚</p>
            <button id="start-button" class="control-button">å¼€å§‹ 10 å…³æŒ‘æˆ˜</button>
            <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
        </div>
    </div>

    <div id="hud">
        <div class="hud-item">å…³å¡: <strong><span id="level-display">1 / 10</span></strong></div>
        <div class="hud-item">æ­¥æ•°: <strong><span id="moves-display">0</span></strong></div>
        <div class="hud-item">æ—¶é—´: <strong><span id="time-display">00:00</span></strong></div>
        <div class="hud-item hud-buttons">
            <button id="undo-button" class="control-button" disabled>â†¶ æ‚”æ£‹ (Z)</button>
            <button id="reset-button" class="control-button" onclick="Game.resetLevel()">â†» é‡ç½® (R)</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒå¸¸é‡å’Œé…ç½® ---
        const TILE_SIZE = 40;
        const GRID_SIZE = 16;
        
        const TILE = {
            FLOOR: 0, WALL: 1, TARGET: 2, PLAYER: 3, BOX: 4
        };

        // 10 ä¸ªå¤æ‚å…³å¡æ•°æ® (16x16)
        const LEVEL_DATA = [
            // Level 1: åŸºç¡€è®¤çŸ¥
            "1111111111111111" + "1000000000000001" + "1000000000000001" + "1004000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1003000000000001" + "1000000000000221" + "1000000000000001" + "1111111111111111",

            // Level 2: Lå½¢é€šé“
            "1111111111111111" + "1220000000000001" + "1204000000000001" + "1001111111111001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1031400000001001" + "1111111111111111",

            // Level 3: å µå¡ç‚¹
            "1111111111111111" + "1220000000000001" + "1001111111111111" + "1040000000000001" + "1001000000000001" + "1041000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1031000000000001" + "1001000000000001" + "1111111111111111",
            
            // Level 4: å››ç®±æ–¹é˜µ
            "1111111111111111" + "1000000000000001" + "1000000000000001" + "1011111111111111" + "101440022000001" + "101440022000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1111111111111111",

            // Level 5: é€šé“ä¾èµ–
            "1111111111111111" + "1220000000000001" + "1011111111111111" + "101000000000001" + "101410000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1000000000000001" + "1111111111111111",

            // Level 6: Uå½¢ç›®æ ‡
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101222210000001" + "101200210000001" + "101240210000001" + "131000000000001" + "1111111111111111",

            // Level 7: ç‹­ç¼
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 8: ç›®æ ‡æ·±å¤„
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 9: äº¤å‰è·¯å¾„
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 10: æœ€ç»ˆè€ƒéªŒ
            "1111111111111111" + "1202000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131400000000001" + "1202000000000001" + "1111111111111111"
        ];

        // --- è®¡æ—¶å™¨ç±» ---
        class Timer {
            constructor(displayId) {
                this.display = document.getElementById(displayId);
                this.startTime = 0;
                this.elapsed = 0;
                this.interval = null;
            }
            start() {
                if (this.interval) return;
                this.startTime = Date.now() - this.elapsed;
                this.interval = setInterval(this.update.bind(this), 1000);
            }
            pause() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                    this.elapsed = Date.now() - this.startTime;
                }
            }
            reset() {
                this.pause();
                this.elapsed = 0;
                this.updateDisplay(0);
            }
            update() {
                this.elapsed = Date.now() - this.startTime;
                this.updateDisplay(Math.floor(this.elapsed / 1000));
            }
            updateDisplay(seconds) {
                const min = String(Math.floor(seconds / 60)).padStart(2, '0');
                const sec = String(seconds % 60).padStart(2, '0');
                this.display.textContent = `${min}:${sec}`;
            }
        }

        // --- æ ¸å¿ƒæ¸¸æˆç±» ---
        class SokobanGame {
            constructor() {
                this.gridElement = document.getElementById('game-grid');
                this.playerElement = document.getElementById('player-element');
                this.dynamicElements = document.getElementById('dynamic-elements');
                
                this.currentLevelIndex = 0;
                this.gameState = 'START';
                this.moves = 0;
                
                this.history = []; 
                this.timer = new Timer('time-display');

                document.getElementById('undo-button').addEventListener('click', this.undoMove.bind(this));
                document.getElementById('start-button').addEventListener('click', () => this.startGame(0));
                
                this.setupInput();
                this.loadLevel(0); // é¢„åŠ è½½ç¬¬ä¸€å…³åœ°å›¾
            }

            // --- å…³å¡ç®¡ç†ä¸åˆå§‹åŒ– ---
            loadLevel(index) {
                this.currentLevelIndex = index;
                const levelData = LEVEL_DATA[index];
                this.mapLayout = [];
                this.player = { x: 0, y: 0 };
                this.boxes = [];
                this.targets = [];
                this.moves = 0;
                this.history = []; 
                this.timer.reset();
                
                // 1. æ¸…ç†å¹¶ç»˜åˆ¶é™æ€åœ°å›¾
                this.gridElement.innerHTML = '';
                
                for (let i = 0; i < levelData.length; i++) {
                    const mapValue = parseInt(levelData[i]);
                    const y = Math.floor(i / GRID_SIZE);
                    const x = i % GRID_SIZE;
                    
                    const tileDiv = document.createElement('div');
                    tileDiv.classList.add('tile');

                    if (mapValue === TILE.WALL) {
                        tileDiv.classList.add('wall');
                        this.mapLayout.push(TILE.WALL);
                    } else if (mapValue === TILE.TARGET) {
                        tileDiv.classList.add('target');
                        tileDiv.innerHTML = 'ğŸ¯';
                        this.targets.push({ x: x, y: y });
                        this.mapLayout.push(TILE.TARGET);
                    } else {
                        this.mapLayout.push(TILE.FLOOR);
                    }
                    
                    // æå–åŠ¨æ€å…ƒç´ ä½ç½®
                    if (mapValue === TILE.PLAYER) {
                        this.player = { x: x, y: y };
                    } else if (mapValue === TILE.BOX) {
                        this.boxes.push({ x: x, y: y });
                    }

                    this.gridElement.appendChild(tileDiv);
                }

                this.saveState(); // ä¿å­˜åˆå§‹çŠ¶æ€
                this.renderDynamicElements();
                this.updateHUD();
            }
            
            resetLevel() {
                this.loadLevel(this.currentLevelIndex);
                this.gameState = 'PLAYING';
                this.timer.start();
                document.getElementById('info-panel').style.display = 'none';
            }

            startGame(startLevelIndex) {
                document.getElementById('info-panel').style.display = 'none';
                this.gameState = 'PLAYING';
                this.loadLevel(startLevelIndex);
                this.timer.start();
            }

            // --- æ¸²æŸ“ (DOMæ“ä½œ) ---
            updateElementPosition(element, x, y) {
                element.style.transform = `translate(${x * TILE_SIZE}px, ${y * TILE_SIZE}px)`;
            }

            renderDynamicElements() {
                // 1. æ¸²æŸ“ç©å®¶
                this.updateElementPosition(this.playerElement, this.player.x, this.player.y);

                // 2. æ¸…ç†æ—§ç®±å­å…ƒç´ å¹¶æ¸²æŸ“æ–°ç®±å­
                let boxElements = this.dynamicElements.querySelectorAll('.box');
                boxElements.forEach(el => el.remove());

                this.boxes.forEach((box, index) => {
                    const boxDiv = document.createElement('div');
                    boxDiv.id = `box-${index}`;
                    boxDiv.classList.add('element', 'box');
                    boxDiv.innerHTML = 'ğŸ“¦';
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡ç‚¹ä¸Š
                    const isOnTarget = this.targets.some(target => target.x === box.x && target.y === box.y);
                    if (isOnTarget) {
                        boxDiv.classList.add('box-on-target');
                    }

                    this.dynamicElements.appendChild(boxDiv);
                    this.updateElementPosition(boxDiv, box.x, box.y);
                });
            }

            // --- æ‚”æ£‹å’ŒçŠ¶æ€ç®¡ç† ---
            saveState() {
                // ç¡®ä¿å†å²è®°å½•ä¸ä¼šè¿‡é•¿
                if (this.history.length >= 50) {
                    this.history.shift(); 
                }
                this.history.push({
                    player: { ...this.player },
                    boxes: this.boxes.map(box => ({ ...box })),
                    moves: this.moves
                });
                this.updateHUD();
            }

            undoMove() {
                if (this.gameState !== 'PLAYING' || this.history.length <= 1) return;

                // ç§»é™¤å½“å‰çŠ¶æ€ï¼Œæ¢å¤åˆ°ä¸Šä¸€ä¸ªçŠ¶æ€
                this.history.pop();
                const prevState = this.history[this.history.length - 1];

                this.player = { ...prevState.player };
                this.boxes = prevState.boxes.map(box => ({ ...box }));
                this.moves = prevState.moves;

                this.renderDynamicElements();
                this.updateHUD();
            }

            // --- ç§»åŠ¨å’Œç¢°æ’é€»è¾‘ ---
            isPassable(x, y) {
                if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return false;
                const index = y * GRID_SIZE + x;
                return this.mapLayout[index] !== TILE.WALL;
            }

            getBoxIndex(x, y) {
                return this.boxes.findIndex(box => box.x === x && box.y === y);
            }

            movePlayer(dx, dy) {
                if (this.gameState !== 'PLAYING') return;

                const newX = this.player.x + dx;
                const newY = this.player.y + dy;
                let moveMade = false;

                if (!this.isPassable(newX, newY)) {
                    return; // æ’å¢™
                }

                const boxIndex = this.getBoxIndex(newX, newY);
                
                if (boxIndex !== -1) {
                    // ç¢°åˆ°ç®±å­ï¼Œå°è¯•æ¨åŠ¨
                    const boxNewX = newX + dx;
                    const boxNewY = newY + dy;

                    // æ£€æŸ¥ç®±å­å‰é¢æ˜¯å¦å¯é€šè¡Œï¼ˆéå¢™å£ä¸”æ²¡æœ‰å…¶ä»–ç®±å­ï¼‰
                    if (!this.isPassable(boxNewX, boxNewY) || this.getBoxIndex(boxNewX, boxNewY) !== -1) {
                        return; // æ¨åŠ¨å¤±è´¥
                    }

                    // æ¨åŠ¨æˆåŠŸ
                    this.boxes[boxIndex].x = boxNewX;
                    this.boxes[boxIndex].y = boxNewY;
                    moveMade = true;
                } else {
                    moveMade = true;
                }
                
                // ç§»åŠ¨ç©å®¶
                if (moveMade) {
                    this.player.x = newX;
                    this.player.y = newY;
                    this.moves++;
                    this.saveState(); 
                    this.renderDynamicElements();
                    this.checkWinCondition();
                }
            }

            checkWinCondition() {
                if (this.targets.length === 0) return;

                const allBoxesOnTarget = this.boxes.every(box => {
                    return this.targets.some(target => target.x === box.x && target.y === box.y);
                });

                if (allBoxesOnTarget) {
                    this.gameState = 'WIN';
                    this.timer.pause();
                    setTimeout(this.showWinScreen.bind(this), 300); 
                }
            }

            // --- ç•Œé¢å’Œ HUD ---
            updateHUD() {
                document.getElementById('level-display').textContent = `${this.currentLevelIndex + 1} / ${LEVEL_DATA.length}`;
                document.getElementById('moves-display').textContent = this.moves;
                // åªæœ‰å½“å†å²è®°å½•å¤§äº1æ—¶ï¼ˆå³æœ‰è‡³å°‘ä¸€ä¸ªéåˆå§‹ç§»åŠ¨ï¼‰æ‰èƒ½æ‚”æ£‹
                document.getElementById('undo-button').disabled = (this.history.length <= 1);
            }
            
            showWinScreen() {
                document.getElementById('info-panel').style.display = 'flex';
                
                let content;
                if (this.currentLevelIndex < LEVEL_DATA.length - 1) {
                    content = `
                        <h1>æ­å–œé€šè¿‡ç¬¬ ${this.currentLevelIndex + 1} å…³!</h1>
                        <p>æ­¥æ•°: ${this.moves} | æ—¶é—´: ${document.getElementById('time-display').textContent}</p>
                        <button id="next-level-button" class="control-button">è¿›å…¥ä¸‹ä¸€å…³</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                    document.getElementById('next-level-button').addEventListener('click', () => this.startGame(this.currentLevelIndex + 1));

                } else {
                    content = `
                        <h1>ğŸ‰ æ­å–œï¼æ‚¨æ˜¯æ¨ç®±å­å¤§å¸ˆï¼</h1>
                        <p>æ‰€æœ‰ ${LEVEL_DATA.length} ä¸ªå…³å¡å®Œæˆï¼</p>
                        <button id="restart-button" class="control-button" onclick="Game.startGame(0)">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                }
            }

            // --- è¾“å…¥å¤„ç† ---
            setupInput() {
                window.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'PLAYING') return;

                    // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 's', 'a', 'd', 'z', 'r'].includes(e.key.toLowerCase())) {
                        e.preventDefault();
                    }

                    let dx = 0;
                    let dy = 0;

                    switch (e.key.toLowerCase()) {
                        case 'arrowup': case 'w': dy = -1; break;
                        case 'arrowdown': case 's': dy = 1; break;
                        case 'arrowleft': case 'a': dx = -1; break;
                        case 'arrowright': case 'd': dx = 1; break;
                        case 'z': this.undoMove(); return;
                        case 'r': this.resetLevel(); return;
                        default: return;
                    }

                    if (dx !== 0 || dy !== 0) {
                        this.movePlayer(dx, dy);
                    }
                });
            }
        }

        // --- å¯åŠ¨æ¸¸æˆ ---
        const Game = new SokobanGame();
        window.Game = Game;
    </script>

</body>
</html>
