<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ç®±å­æœ€ç»ˆç¨³å®šç‰ˆ</title>
    <style>
        /* --- æ•´ä½“å¸ƒå±€ --- */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #333;
            color: #eee;
            font-family: 'Courier New', monospace;
            user-select: none;
        }
        h1 {
            color: #4CAF50;
            font-size: 2.5em;
        }

        /* --- æ¸¸æˆç½‘æ ¼å’Œå®¹å™¨é…ç½® --- */
        #game-container {
            position: relative;
            width: 500px;
            height: 500px;
            border: 4px solid #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.7);
        }
        #game-grid {
            /* 10x10 ç½‘æ ¼ï¼Œæ¯æ ¼ 50px */
            display: grid;
            grid-template-columns: repeat(10, 50px);
            grid-template-rows: repeat(10, 50px);
            background-color: #555;
        }

        /* --- ç“¦ç‰‡æ ·å¼ (é™æ€åœ°å›¾) --- */
        .tile {
            width: 50px;
            height: 50px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
        }
        .wall {
            background-color: #614d4d; 
            border: 1px solid #795548;
        }
        .floor {
            background-color: #555;
        }
        .target {
            background-color: #444; 
            border: 2px dashed #FFEB3B; 
            color: #FFEB3B;
        }

        /* --- åŠ¨æ€å…ƒç´  (ä½¿ç”¨ç»å¯¹å®šä½å®ç°ç§»åŠ¨) --- */
        #dynamic-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .element {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            transition: transform 0.2s ease-out; /* å¹³æ»‘ç§»åŠ¨åŠ¨ç”» */
            pointer-events: none;
            box-sizing: border-box;
        }
        .player {
            background-color: #2196F3;
            border-radius: 50%;
            border: 2px solid #fff;
            color: #fff;
            z-index: 5;
        }
        .box {
            background-color: #FF9800; 
            border: 3px solid #E65100;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            color: #000;
            z-index: 4;
        }
        .box-on-target {
            background-color: #4CAF50; /* ç»¿è‰²è¡¨ç¤ºåˆ°ä½ */
            border-color: #388E3C;
        }

        /* --- HUD å’Œæ§åˆ¶ --- */
        #hud {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #444;
            border-radius: 8px;
        }
        .hud-item strong {
            color: #4CAF50;
        }
        .control-button {
            padding: 8px 15px;
            font-size: 1em;
            cursor: pointer;
            background-color: #FF5722; 
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .control-button:hover {
            background-color: #E64A19;
        }

        /* --- è¦†ç›–é¢æ¿ --- */
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
        }
        .start-button {
            background-color: #4CAF50;
            margin-top: 15px;
        }
        .start-button:hover {
            background-color: #388E3C;
        }
    </style>
</head>
<body>

    <h1>ğŸ“¦ æ¨ç®±å­ 8 å…³æŒ‘æˆ˜ (Level 2 å·²ä¿®æ­£)</h1>

    <div id="game-container">
        <div id="game-grid"></div>

        <div id="dynamic-elements">
            <div id="player-element" class="element player">ğŸš¶</div>
        </div>

        <div id="info-panel">
            <h1>æ¨ç®±å­æŒ‘æˆ˜</h1>
            <p>æ“ä½œï¼šæ–¹å‘é”®/WASD ç§»åŠ¨ã€‚</p>
            <p><strong>R</strong>: é‡ç½®å…³å¡</p>
            <p>ç›®æ ‡ï¼šå°†æ‰€æœ‰ç®±å­æ¨åˆ°ç›®æ ‡ç‚¹ä¸Šã€‚</p>
            <button id="start-button" class="control-button start-button">å¼€å§‹æ¸¸æˆ</button>
            <p style="margin-top: 20px; color:#aaa;">(æ€»å…± 8 ä¸ªå…³å¡)</p>
        </div>
    </div>

    <div id="hud">
        <div class="hud-item">å…³å¡: <strong><span id="level-display">1 / 8</span></strong></div>
        <div class="hud-item">æ­¥æ•°: <strong><span id="moves-display">0</span></strong></div>
        <div class="hud-item">
            <button id="reset-button" class="control-button" onclick="Game.resetLevel()">â†» é‡ç½® (R)</button>
        </div>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒå¸¸é‡å’Œé…ç½® ---
        const TILE_SIZE = 50;
        const GRID_SIZE = 10; // 10x10 ç½‘æ ¼
        
        const TILE = {
            FLOOR: 0, WALL: 1, TARGET: 2, PLAYER: 3, BOX: 4
        };

        // 8 ä¸ªç¨³å®šå…³å¡æ•°æ® (10x10)
        // P=3, B=4, T=2, W=1, F=0
        const LEVEL_DATA = [
            // Level 1: åŸºç¡€
            "1111111111" + "1000000001" + "1004000001" + "1000000001" + "1000000001" + "1000000001" + "1000000001" + "1000000001" + "1113002211" + "1111111111",

            // ** Level 2: Lå½¢é€šé“ (å·²ä¿®æ­£) **
            "1111111111" + "1000000001" + "1011111101" + "1010000101" + "1014000101" + "1010000101" + "1000000101" + "1300000101" + "1220000001" + "1111111111",

            // Level 3: ç‹­çª„å…¥å£
            "1111111111" + "1000000001" + "1011111101" + "1010000101" + "1410000101" + "1010000101" + "1010000101" + "1310000101" + "1220000001" + "1111111111",
            
            // Level 4: ä¸¤ä¸ªç®±å­
            "1111111111" + "1220000001" + "1001111101" + "1401000101" + "1001400101" + "1001000101" + "1001000101" + "1000000101" + "1113000001" + "1111111111",

            // Level 5: å››é¢å¢™ç¯ç»•ç›®æ ‡
            "1111111111" + "1000000001" + "1011111101" + "1010000101" + "1412100101" + "1011111101" + "1000000001" + "1000000001" + "1300000001" + "1111111111",

            // Level 6: é’¥åŒ™å­”
            "1111111111" + "1000000001" + "1011111101" + "1014000101" + "1010000101" + "1010000101" + "1010000101" + "1310000101" + "1220000001" + "1111111111",
            
            // Level 7: æ²¿è¾¹æ¨
            "1111111111" + "1000000001" + "1011111101" + "1014000101" + "1010000101" + "1010000101" + "1010000101" + "1010000101" + "1312200001" + "1111111111",

            // Level 8: æœ€åçš„è€ƒéªŒ (4ä¸ªç®±å­ï¼Œ4ä¸ªç›®æ ‡)
            "1111111111" + "1202000001" + "1011111101" + "1414000101" + "1010000101" + "1410000101" + "1010000101" + "1010000101" + "1312200001" + "1111111111"
        ];

        // --- 2. æ ¸å¿ƒæ¸¸æˆç±» ---
        class SokobanGame {
            constructor() {
                this.gridElement = document.getElementById('game-grid');
                this.playerElement = document.getElementById('player-element');
                this.dynamicElements = document.getElementById('dynamic-elements');
                
                this.currentLevelIndex = 0;
                this.gameState = 'START';
                this.moves = 0;
                
                this.setupInput();
                document.getElementById('start-button').addEventListener('click', () => this.startGame(0));
                
                this.loadLevel(0); 
            }

            // --- 2.1. å…³å¡ç®¡ç†ä¸åˆå§‹åŒ– ---
            loadLevel(index) {
                this.currentLevelIndex = index;
                const levelData = LEVEL_DATA[index];
                this.mapLayout = [];
                this.player = { x: 0, y: 0 };
                this.boxes = [];
                this.moves = 0;
                
                this.gridElement.innerHTML = ''; 
                
                for (let i = 0; i < levelData.length; i++) {
                    const mapValue = parseInt(levelData[i]);
                    const y = Math.floor(i / GRID_SIZE);
                    const x = i % GRID_SIZE;
                    
                    const tileDiv = document.createElement('div');
                    tileDiv.classList.add('tile');

                    // 1. å»ºç«‹é™æ€åœ°å›¾ (å¢™å£ã€åœ°æ¿ã€ç›®æ ‡ç‚¹)
                    if (mapValue === TILE.WALL) {
                        tileDiv.classList.add('wall');
                        this.mapLayout.push(TILE.WALL);
                    } else if (mapValue === TILE.TARGET) {
                        tileDiv.classList.add('target');
                        tileDiv.innerHTML = 'â—';
                        this.mapLayout.push(TILE.TARGET);
                    } else {
                        tileDiv.classList.add('floor');
                        this.mapLayout.push(TILE.FLOOR);
                    }
                    
                    // 2. æå–åŠ¨æ€å…ƒç´ ä½ç½® (ç©å®¶å’Œç®±å­)
                    if (mapValue === TILE.PLAYER) {
                        this.player = { x: x, y: y };
                    } else if (mapValue === TILE.BOX) {
                        this.boxes.push({ x: x, y: y });
                    }

                    this.gridElement.appendChild(tileDiv);
                }

                this.renderDynamicElements();
                this.updateHUD();
            }
            
            resetLevel() {
                this.loadLevel(this.currentLevelIndex);
                this.gameState = 'PLAYING';
                document.getElementById('info-panel').style.display = 'none';
            }

            startGame(startLevelIndex) {
                document.getElementById('info-panel').style.display = 'none';
                this.gameState = 'PLAYING';
                this.loadLevel(startLevelIndex);
            }

            // --- 2.2. æ¸²æŸ“ (DOMæ“ä½œ) ---
            updateElementPosition(element, x, y) {
                // æ ¸å¿ƒå®šä½é€»è¾‘ï¼šä½¿ç”¨ TILE_SIZE è¿›è¡Œç²¾ç¡®å¹³ç§»
                element.style.transform = `translate(${x * TILE_SIZE}px, ${y * TILE_SIZE}px)`;
            }

            renderDynamicElements() {
                // 1. æ¸²æŸ“ç©å®¶
                this.updateElementPosition(this.playerElement, this.player.x, this.player.y);

                // 2. æ¸…ç†æ—§ç®±å­å…ƒç´ å¹¶æ¸²æŸ“æ–°ç®±å­
                let boxElements = this.dynamicElements.querySelectorAll('.box');
                boxElements.forEach(el => el.remove());

                this.boxes.forEach((box, index) => {
                    const boxDiv = document.createElement('div');
                    boxDiv.id = `box-${index}`;
                    boxDiv.classList.add('element', 'box');
                    boxDiv.innerHTML = 'ğŸ“¦';
                    
                    const index_flat = box.y * GRID_SIZE + box.x;
                    const isOnTarget = this.mapLayout[index_flat] === TILE.TARGET;
                    
                    if (isOnTarget) {
                        boxDiv.classList.add('box-on-target');
                    }

                    this.dynamicElements.appendChild(boxDiv);
                    this.updateElementPosition(boxDiv, box.x, box.y); 
                });
            }

            // --- 2.3. ç§»åŠ¨å’Œç¢°æ’é€»è¾‘ ---
            getTile(x, y) {
                if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return TILE.WALL;
                const index = y * GRID_SIZE + x;
                return this.mapLayout[index];
            }

            getBoxIndex(x, y) {
                return this.boxes.findIndex(box => box.x === x && box.y === y);
            }

            movePlayer(dx, dy) {
                if (this.gameState !== 'PLAYING') return;

                const newX = this.player.x + dx;
                const newY = this.player.y + dy;
                const nextTile = this.getTile(newX, newY);

                if (nextTile === TILE.WALL) {
                    return; // æ’å¢™
                }

                const boxIndex = this.getBoxIndex(newX, newY);
                let moveMade = false;
                
                if (boxIndex !== -1) {
                    // ç¢°åˆ°ç®±å­ï¼Œå°è¯•æ¨åŠ¨
                    const boxNewX = newX + dx;
                    const boxNewY = newY + dy;
                    const boxNextTile = this.getTile(boxNewX, boxNewY);

                    // æ£€æŸ¥ç®±å­å‰é¢æ˜¯å¦å¯é€šè¡Œï¼ˆéå¢™å£ä¸”æ²¡æœ‰å…¶ä»–ç®±å­ï¼‰
                    if (boxNextTile === TILE.WALL || this.getBoxIndex(boxNewX, boxNewY) !== -1) {
                        return; // æ¨åŠ¨å¤±è´¥
                    }

                    // æ¨åŠ¨æˆåŠŸ
                    this.boxes[boxIndex].x = boxNewX;
                    this.boxes[boxIndex].y = boxNewY;
                    moveMade = true;
                } else {
                    moveMade = true;
                }
                
                // ç§»åŠ¨ç©å®¶
                if (moveMade) {
                    this.player.x = newX;
                    this.player.y = newY;
                    this.moves++;
                    this.renderDynamicElements();
                    this.updateHUD();
                    this.checkWinCondition();
                }
            }

            checkWinCondition() {
                // æ£€æŸ¥æ‰€æœ‰ç®±å­æ˜¯å¦éƒ½åœ¨ç›®æ ‡ç‚¹ä¸Š
                const allBoxesOnTarget = this.boxes.every(box => {
                    const index_flat = box.y * GRID_SIZE + box.x;
                    return this.mapLayout[index_flat] === TILE.TARGET;
                });

                if (allBoxesOnTarget) {
                    this.gameState = 'WIN';
                    setTimeout(this.showWinScreen.bind(this), 300); 
                }
            }

            // --- 2.4. ç•Œé¢å’Œ HUD ---
            updateHUD() {
                document.getElementById('level-display').textContent = `${this.currentLevelIndex + 1} / ${LEVEL_DATA.length}`;
                document.getElementById('moves-display').textContent = this.moves;
            }
            
            showWinScreen() {
                document.getElementById('info-panel').style.display = 'flex';
                
                let content;
                if (this.currentLevelIndex < LEVEL_DATA.length - 1) {
                    // è¿›å…¥ä¸‹ä¸€å…³
                    content = `
                        <h1>æ­å–œé€šè¿‡ç¬¬ ${this.currentLevelIndex + 1} å…³!</h1>
                        <p>æ­¥æ•°: ${this.moves}</p>
                        <button id="next-level-button" class="control-button start-button">è¿›å…¥ä¸‹ä¸€å…³</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #4CAF50;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                    document.getElementById('next-level-button').addEventListener('click', () => this.startGame(this.currentLevelIndex + 1));

                } else {
                    // å…¨éƒ¨é€šå…³
                    content = `
                        <h1>ğŸ‰ å®Œç¾ï¼æŒ‘æˆ˜å®Œæˆï¼</h1>
                        <p>æ‰€æœ‰ ${LEVEL_DATA.length} ä¸ªå…³å¡éƒ½å·²é€šè¿‡ã€‚</p>
                        <button id="restart-button" class="control-button start-button" onclick="Game.startGame(0)">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #4CAF50;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                }
            }

            // --- 2.5. è¾“å…¥å¤„ç† ---
            setupInput() {
                window.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'PLAYING') return;

                    // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 's', 'a', 'd', 'r'].includes(e.key.toLowerCase())) {
                        e.preventDefault();
                    }

                    let dx = 0;
                    let dy = 0;

                    switch (e.key.toLowerCase()) {
                        case 'arrowup': case 'w': dy = -1; break;
                        case 'arrowdown': case 's': dy = 1; break;
                        case 'arrowleft': case 'a': dx = -1; break;
                        case 'arrowright': case 'd': dx = 1; break;
                        case 'r': this.resetLevel(); return;
                        default: return;
                    }

                    if (dx !== 0 || dy !== 0) {
                        this.movePlayer(dx, dy);
                    }
                });
            }
        }

        // --- 3. å¯åŠ¨æ¸¸æˆ ---
        const Game = new SokobanGame();
        window.Game = Game; 
    </script>

</body>
</html>
