<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ç®±å­å¤§å¸ˆ - æ‚”æ£‹ä¸è®¡æ—¶æŒ‘æˆ˜</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a2e; /* æ·±å¤ªç©ºè“ */
            color: #e9e9e9;
            flex-direction: column;
            font-family: 'Courier New', monospace;
        }
        h1 {
            color: #ffcc00;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        #game-container {
            border: 4px solid #00aaff;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.8);
            position: relative;
        }
        #game-canvas {
            display: block;
            background-color: #333344; 
        }
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        .control-button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            background-color: #ff6f61; /* çŠç‘šçº¢æŒ‰é’® */
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .control-button:hover {
            background-color: #e55a5a;
        }
        #hud {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #333344;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .hud-item strong {
            color: #00aaff;
        }
        .hud-buttons button {
            background-color: #666;
            margin-left: 10px;
        }
        .hud-buttons button:hover {
            background-color: #888;
        }
    </style>
</head>
<body>

    <h1>ğŸ“¦ æ¨ç®±å­å¤§å¸ˆ</h1>

    <div id="game-container">
        <canvas id="game-canvas" width="640" height="640"></canvas> 
        <div id="info-panel">
            <h1>æ¨ç®±å­å¤§å¸ˆ</h1>
            <p>æ“ä½œï¼šæ–¹å‘é”®/WASD ç§»åŠ¨ã€‚</p>
            <p><strong>R</strong>: é‡ç½®å…³å¡ | <strong>Z</strong>: æ‚”æ£‹ (Undo)</p>
            <p>ç›®æ ‡ï¼šå°†æ‰€æœ‰ç®±å­æ¨åˆ°ç›®æ ‡ç‚¹ä¸Šã€‚</p>
            <button id="start-button" class="control-button">å¼€å§‹ 10 å…³æŒ‘æˆ˜</button>
            <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
        </div>
    </div>

    <div id="hud">
        <div class="hud-item">å…³å¡: <strong><span id="level-display">1 / 10</span></strong></div>
        <div class="hud-item">æ­¥æ•°: <strong><span id="moves-display">0</span></strong></div>
        <div class="hud-item">æ—¶é—´: <strong><span id="time-display">00:00</span></strong></div>
        <div class="hud-item hud-buttons">
            <button id="undo-button" class="control-button">â†¶ æ‚”æ£‹ (Z)</button>
            <button id="reset-button" class="control-button" onclick="Game.resetLevel()">â†» é‡ç½® (R)</button>
        </div>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒå¸¸é‡å’Œé…ç½® ---
        const TILE_SIZE = 40;
        const GRID_SIZE = 16; // 16x16 ç½‘æ ¼ï¼Œæ€»å…± 256 ä¸ªç“¦ç‰‡
        const CANVAS_SIZE = TILE_SIZE * GRID_SIZE;

        // å…ƒç´ ç±»å‹å®šä¹‰
        const TILE = {
            FLOOR: 0,
            WALL: 1,
            TARGET: 2,
            PLAYER: 3,
            BOX: 4,
            PLAYER_ON_TARGET: 5,
            BOX_ON_TARGET: 6
        };

        // 10 ä¸ªå¤æ‚å…³å¡æ•°æ® (æ›´å¤§åœ°å›¾ 16x16, éš¾åº¦æå‡)
        // P=3 (Player), B=4 (Box), T=2 (Target), W=1 (Wall), F=0 (Floor)
        const LEVEL_DATA = [
            // Level 1: åŸºç¡€è®¤çŸ¥
            "1111111111111111" + "1000000000000001" + "1000000000000001" + "1004000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1000000000000001" + "1003000000000001" + "1000000000000221" + "1000000000000001" + "1111111111111111",

            // Level 2: Lå½¢é€šé“
            "1111111111111111" + "1220000000000001" + "1204000000000001" + "1001111111111001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1001000000001001" + "1031400000001001" + "1111111111111111",

            // Level 3: å µå¡ç‚¹ (éœ€è¦æ¨å¼€ä¸€ä¸ªç®±å­æ‰èƒ½æ¨å¦ä¸€ä¸ª)
            "1111111111111111" + "1220000000000001" + "1001111111111111" + "1040000000000001" + "1001000000000001" + "1041000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1001000000000001" + "1031000000000001" + "1001000000000001" + "1111111111111111",
            
            // Level 4: å››ç®±æ–¹é˜µ
            "1111111111111111" + "1000000000000001" + "1000000000000001" + "1011111111111111" + "101440022000001" + "101440022000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1111111111111111",

            // Level 5: é€šé“ä¾èµ– (éœ€è¦æ¨å¼€ä¸€ä¸ªç®±å­æ‰èƒ½æ¨å¦ä¸€ä¸ª)
            "1111111111111111" + "1220000000000001" + "1011111111111111" + "101000000000001" + "101410000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1000000000000001" + "1111111111111111",

            // Level 6: Uå½¢ç›®æ ‡
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101222210000001" + "101200210000001" + "101240210000001" + "131000000000001" + "1111111111111111",

            // Level 7: ç‹­ç¼
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 8: ç›®æ ‡æ·±å¤„
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 9: äº¤å‰è·¯å¾„
            "1111111111111111" + "1000000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131000000000001" + "1220000000000001" + "1111111111111111",

            // Level 10: æœ€ç»ˆè€ƒéªŒ (4 boxes, 4 targets)
            "1111111111111111" + "1202000000000001" + "1011111111111111" + "101400000000001" + "101010000000001" + "101410000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101010000000001" + "101000000000001" + "101000000000001" + "131400000000001" + "1202000000000001" + "1111111111111111"
        ];

        // --- 2. æ¸¸æˆçŠ¶æ€å’Œæ—¶é—´ç®¡ç† ---
        class Timer {
            constructor(displayId) {
                this.display = document.getElementById(displayId);
                this.startTime = 0;
                this.elapsed = 0;
                this.interval = null;
            }

            start() {
                if (this.interval) return;
                this.startTime = Date.now() - this.elapsed;
                this.interval = setInterval(this.update.bind(this), 1000);
            }

            pause() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                    this.elapsed = Date.now() - this.startTime;
                }
            }

            reset() {
                this.pause();
                this.elapsed = 0;
                this.updateDisplay(0);
            }

            update() {
                this.elapsed = Date.now() - this.startTime;
                this.updateDisplay(Math.floor(this.elapsed / 1000));
            }

            updateDisplay(seconds) {
                const min = String(Math.floor(seconds / 60)).padStart(2, '0');
                const sec = String(seconds % 60).padStart(2, '0');
                this.display.textContent = `${min}:${sec}`;
            }
        }

        // --- 3. åœ°å›¾å’Œæ¸¸æˆçŠ¶æ€ç±» ---
        class SokobanGame {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = CANVAS_SIZE;
                this.canvas.height = CANVAS_SIZE;

                this.currentLevelIndex = 0;
                this.gameState = 'START';
                this.moves = 0;
                
                // æ‚”æ£‹å†å²ï¼šå­˜å‚¨æ¯æ¬¡ç§»åŠ¨åçš„åœ°å›¾ã€ç©å®¶å’Œç®±å­çŠ¶æ€
                this.history = []; 
                this.maxHistorySize = 50; 

                // å®ä¾‹åŒ–è®¡æ—¶å™¨
                this.timer = new Timer('time-display');

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('undo-button').addEventListener('click', this.undoMove.bind(this));
                document.getElementById('start-button').addEventListener('click', () => this.startGame(0));

                this.setupInput();
                this.drawLoop();
            }

            // --- 3.1. å…³å¡ç®¡ç† ---
            loadLevel(index) {
                this.currentLevelIndex = index;
                const levelData = LEVEL_DATA[index];
                this.mapLayout = [];
                this.player = { x: 0, y: 0 };
                this.boxes = [];
                this.targets = [];
                this.moves = 0;
                this.history = []; // æ¸…ç©ºå†å²è®°å½•
                this.timer.reset();

                for (let i = 0; i < levelData.length; i++) {
                    const mapValue = parseInt(levelData[i]);
                    const y = Math.floor(i / GRID_SIZE);
                    const x = i % GRID_SIZE;

                    if (mapValue === TILE.PLAYER) {
                        this.player = { x: x, y: y };
                        this.mapLayout.push(TILE.FLOOR); // ç©å®¶ä½ç½®ä¹Ÿæ˜¯åœ°æ¿
                    } else if (mapValue === TILE.BOX) {
                        this.boxes.push({ x: x, y: y });
                        this.mapLayout.push(TILE.FLOOR); // ç®±å­ä½ç½®ä¹Ÿæ˜¯åœ°æ¿
                    } else if (mapValue === TILE.TARGET) {
                        this.targets.push({ x: x, y: y });
                        this.mapLayout.push(TILE.TARGET); 
                    } else {
                        this.mapLayout.push(mapValue); // å¢™å£æˆ–åœ°æ¿
                    }
                }
                this.saveState(); // ä¿å­˜åˆå§‹çŠ¶æ€
                this.updateHUD();
            }
            
            resetLevel() {
                this.loadLevel(this.currentLevelIndex);
                this.gameState = 'PLAYING';
                this.timer.start();
                document.getElementById('info-panel').style.display = 'none';
            }

            startGame(startLevelIndex) {
                document.getElementById('info-panel').style.display = 'none';
                this.gameState = 'PLAYING';
                this.loadLevel(startLevelIndex);
                this.timer.start();
            }

            // --- 3.2. æ‚”æ£‹å’ŒçŠ¶æ€ç®¡ç† ---
            saveState() {
                if (this.history.length >= this.maxHistorySize) {
                    this.history.shift(); // ç§»é™¤æœ€æ—§çš„è®°å½•
                }
                this.history.push({
                    player: { ...this.player },
                    boxes: this.boxes.map(box => ({ ...box })),
                    moves: this.moves
                });
                this.updateHUD(); // æ›´æ–°æ‚”æ£‹æŒ‰é’®çŠ¶æ€
            }

            undoMove() {
                if (this.gameState !== 'PLAYING' || this.history.length <= 1) return;

                // ç§»é™¤å½“å‰çŠ¶æ€ï¼Œæ¢å¤åˆ°ä¸Šä¸€ä¸ªçŠ¶æ€
                this.history.pop();
                const prevState = this.history[this.history.length - 1];

                this.player = { ...prevState.player };
                this.boxes = prevState.boxes.map(box => ({ ...box }));
                this.moves = prevState.moves;

                this.updateHUD();
            }


            // --- 3.3. ç§»åŠ¨å’Œç¢°æ’é€»è¾‘ ---
            isPassable(x, y) {
                const index = y * GRID_SIZE + x;
                // è¾¹ç•Œå’Œå¢™å£æ£€æŸ¥
                return x >= 0 && x < GRID_SIZE && y >= 0 && y < GRID_SIZE && this.mapLayout[index] !== TILE.WALL;
            }

            getBoxIndex(x, y) {
                return this.boxes.findIndex(box => box.x === x && box.y === y);
            }

            movePlayer(dx, dy) {
                if (this.gameState !== 'PLAYING') return;

                const newX = this.player.x + dx;
                const newY = this.player.y + dy;

                if (!this.isPassable(newX, newY)) {
                    return; // æ’å¢™
                }

                const boxIndex = this.getBoxIndex(newX, newY);
                
                if (boxIndex !== -1) {
                    // ç¢°åˆ°ç®±å­ï¼Œå°è¯•æ¨åŠ¨
                    const boxNewX = newX + dx;
                    const boxNewY = newY + dy;

                    // æ£€æŸ¥ç®±å­å‰é¢æ˜¯å¦å¯é€šè¡Œï¼ˆéå¢™å£ä¸”æ²¡æœ‰å…¶ä»–ç®±å­ï¼‰
                    if (!this.isPassable(boxNewX, boxNewY) || this.getBoxIndex(boxNewX, boxNewY) !== -1) {
                        return; // æ¨åŠ¨å¤±è´¥
                    }

                    // æ¨åŠ¨æˆåŠŸ
                    this.boxes[boxIndex].x = boxNewX;
                    this.boxes[boxIndex].y = boxNewY;
                }
                
                // ç§»åŠ¨ç©å®¶
                this.player.x = newX;
                this.player.y = newY;
                this.moves++;

                this.saveState(); // ç§»åŠ¨æˆåŠŸåä¿å­˜çŠ¶æ€

                this.checkWinCondition();
            }

            checkWinCondition() {
                if (this.targets.length === 0) return;

                const allBoxesOnTarget = this.boxes.every(box => {
                    return this.targets.some(target => target.x === box.x && target.y === box.y);
                });

                if (allBoxesOnTarget) {
                    this.gameState = 'WIN';
                    this.timer.pause();
                    setTimeout(this.showWinScreen.bind(this), 300); 
                }
            }

            // --- 3.4. æ¸²æŸ“å’Œç•Œé¢ ---
            updateHUD() {
                document.getElementById('level-display').textContent = `${this.currentLevelIndex + 1} / ${LEVEL_DATA.length}`;
                document.getElementById('moves-display').textContent = this.moves;
                document.getElementById('undo-button').disabled = (this.history.length <= 1);
            }

            drawTile(x, y, color, symbol = '', secondaryColor = null) {
                const px = x * TILE_SIZE;
                const py = y * TILE_SIZE;

                // ç»˜åˆ¶èƒŒæ™¯/ä¸»ä½“
                this.ctx.fillStyle = color;
                this.ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);

                // ç»˜åˆ¶é˜´å½± (å¢åŠ å¤æ‚åº¦å’Œè§†è§‰æ•ˆæœ)
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                this.ctx.fillRect(px + TILE_SIZE - 5, py, 5, TILE_SIZE); // å³ä¾§é˜´å½±
                this.ctx.fillRect(px, py + TILE_SIZE - 5, TILE_SIZE, 5); // åº•éƒ¨é˜´å½±

                if (secondaryColor) {
                    // ç»˜åˆ¶è¾¹æ¡†æˆ–è£…é¥°
                    this.ctx.strokeStyle = secondaryColor;
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                }

                // ç»˜åˆ¶ç¬¦å· (æ–‡æœ¬)
                if (symbol) {
                    this.ctx.fillStyle = '#000';
                    this.ctx.font = `${TILE_SIZE * 0.7}px monospace`;
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(symbol, px + TILE_SIZE / 2, py + TILE_SIZE / 2);
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                this.ctx.fillStyle = '#333344';
                this.ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // 1. ç»˜åˆ¶åœ°å›¾ (å¢™å£å’Œåœ°æ¿/ç›®æ ‡ç‚¹)
                for (let y = 0; y < GRID_SIZE; y++) {
                    for (let x = 0; x < GRID_SIZE; x++) {
                        const index = y * GRID_SIZE + x;
                        const mapValue = this.mapLayout[index];

                        if (mapValue === TILE.WALL) {
                            this.drawTile(x, y, '#5b5530', '', '#a19555');
                        } else if (mapValue === TILE.TARGET) {
                            this.drawTile(x, y, '#444', 'ğŸ¯', '#ff6f61');
                        } else {
                            this.drawTile(x, y, '#333344'); // åœ°æ¿
                        }
                    }
                }

                // 2. ç»˜åˆ¶ç®±å­
                this.boxes.forEach(box => {
                    const isOnTarget = this.targets.some(target => target.x === box.x && target.y === box.y);
                    const color = isOnTarget ? '#2ecc71' : '#f39c12';
                    const symbol = 'ğŸ“¦';
                    this.drawTile(box.x, box.y, color, symbol, '#fff');
                });

                // 3. ç»˜åˆ¶ç©å®¶
                this.drawTile(this.player.x, this.player.y, '#3498db', 'ğŸƒ', '#fff');
            }

            drawLoop() {
                this.draw();
                requestAnimationFrame(this.drawLoop.bind(this));
            }
            
            showWinScreen() {
                document.getElementById('info-panel').style.display = 'flex';
                
                let content;
                if (this.currentLevelIndex < LEVEL_DATA.length - 1) {
                    // è¿›å…¥ä¸‹ä¸€å…³
                    content = `
                        <h1>æ­å–œé€šè¿‡ç¬¬ ${this.currentLevelIndex + 1} å…³!</h1>
                        <p>æ­¥æ•°: ${this.moves} | æ—¶é—´: ${document.getElementById('time-display').textContent}</p>
                        <button id="next-level-button" class="control-button">è¿›å…¥ä¸‹ä¸€å…³</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                    document.getElementById('next-level-button').addEventListener('click', () => this.startGame(this.currentLevelIndex + 1));

                } else {
                    // å…¨éƒ¨é€šå…³
                    content = `
                        <h1>ğŸ‰ æ­å–œï¼æ‚¨æ˜¯æ¨ç®±å­å¤§å¸ˆï¼</h1>
                        <p>æ‰€æœ‰ ${LEVEL_DATA.length} ä¸ªå…³å¡å®Œæˆï¼</p>
                        <button id="restart-button" class="control-button" onclick="Game.startGame(0)">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
                        <p style="margin-top: 20px;"><a href="index.html" style="color: #00aaff;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                    `;
                    document.getElementById('info-panel').innerHTML = content;
                }
            }

            // --- 3.5. è¾“å…¥å¤„ç† ---
            setupInput() {
                window.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'PLAYING') return;

                    // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼Œå¦‚é¡µé¢æ»šåŠ¨
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 's', 'a', 'd', 'z', 'r'].includes(e.key.toLowerCase())) {
                        e.preventDefault();
                    }

                    let dx = 0;
                    let dy = 0;

                    switch (e.key.toLowerCase()) {
                        case 'arrowup':
                        case 'w':
                            dy = -1;
                            break;
                        case 'arrowdown':
                        case 's':
                            dy = 1;
                            break;
                        case 'arrowleft':
                        case 'a':
                            dx = -1;
                            break;
                        case 'arrowright':
                        case 'd':
                            dx = 1;
                            break;
                        case 'z': // æ‚”æ£‹
                            this.undoMove();
                            return;
                        case 'r': // é‡ç½®
                            this.resetLevel();
                            return;
                        default:
                            return;
                    }

                    if (dx !== 0 || dy !== 0) {
                        this.movePlayer(dx, dy);
                    }
                });
            }
        }

        // --- 4. å¯åŠ¨æ¸¸æˆ ---
        const Game = new SokobanGame('game-canvas');

        // å°†å…¨å±€å‡½æ•°æš´éœ²ç»™ HTML æŒ‰é’®
        window.Game = Game;
        Game.loadLevel(0); // é¢„åŠ è½½ç¬¬ä¸€å…³åœ°å›¾
    </script>

</body>
</html>
