<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹å—æ¶ˆé™¤ - 10 å…³æŒ‘æˆ˜</title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #263238; 
            color: white;
            flex-direction: column;
            font-family: monospace, sans-serif;
        }
        #game-container {
            border: 3px solid #64b5f6;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.7);
            position: relative;
        }
        #game-canvas {
            display: block;
            background-color: #455a64; 
        }
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        #info-panel h1 {
            color: #ffeb3b;
            font-size: 3em;
        }
        .control-button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            background-color: #ff9800; 
            color: white;
            border: none;
            transition: background-color 0.3s;
        }
        .control-button:hover {
            background-color: #f57c00;
        }
        .hud-item {
            margin-top: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <h1>ğŸ§± æ–¹å—æ¶ˆé™¤ - 10 å…³æŒ‘æˆ˜</h1>

    <div id="game-container">
        <canvas id="game-canvas" width="400" height="400"></canvas>

        <div id="info-panel">
            <h1>æ–¹å—æ¶ˆé™¤</h1>
            <p>æ“ä½œï¼šæ–¹å‘é”®/WASD ç§»åŠ¨ã€‚</p>
            <p>ç›®æ ‡ï¼šå°†æ‰€æœ‰ç®±å­ (ğŸ“¦) æ¨åˆ°ç›®æ ‡ç‚¹ (ğŸ¯) ä¸Šã€‚</p>
            <button id="start-button" class="control-button">å¼€å§‹è§£è°œ</button>
            <p class="hud-item"><a href="index.html" style="color: #64b5f6;">è¿”å›æ¸¸æˆå¤§å…</a></p>
        </div>
    </div>

    <div class="hud-item">
        å…³å¡: <span id="level-display">1 / 10</span> | æ­¥æ•°: <span id="moves-display">0</span> 
        <button id="reset-button" class="control-button" onclick="resetLevel()">é‡ç½®å…³å¡ (R)</button>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const GAME_SIZE = canvas.width;

        let gameState = 'START';
        const TILE_SIZE = 40;
        const GRID_SIZE = 10; // 10x10 ç½‘æ ¼

        // ç©å®¶ã€ç®±å­å’Œåœ°å›¾çŠ¶æ€
        let player = { x: 0, y: 0 };
        let boxes = [];
        let targets = [];
        let mapLayout = []; // åªå­˜å‚¨å¢™å£å’Œåœ°æ¿
        let startPositions = { player: { x: 0, y: 0 }, boxes: [] }; // ç”¨äºé‡ç½®

        let currentLevelIndex = 0;
        let moves = 0;

        // --- å…³å¡æ•°æ® (10 å…³) ---
        // 0: åœ°æ¿, 1: å¢™å£, 2: ç›®æ ‡ç‚¹, 3: ç©å®¶, 4: ç®±å­
        const levels = [
            // Level 1: ç®€å•æ¨å…¥ (2 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,0,0,0,0,0,0,0,0,1, 1,0,4,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,3,0,0,0,0,2,2,1, 1,0,4,0,0,0,0,0,0,1, 1,1,1,1,1,1,1,1,1,1],
            
            // Level 2: å¢™å£éšœç¢ (2 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,0,0,0,0,0,0,0,0,1, 1,0,4,1,1,1,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,1,0,0,0,1, 1,0,0,0,0,1,0,0,0,1, 1,0,3,0,0,0,0,2,2,1, 1,0,4,0,0,0,0,0,0,1, 1,1,1,1,1,1,1,1,1,1],

            // Level 3: ç›®æ ‡ç‚¹åˆ†æ•£ (3 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,0,0,0,0,0,0,0,1, 1,0,4,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,1,0,1, 1,0,0,0,0,0,0,1,0,1, 1,0,4,1,1,1,0,1,0,1, 1,0,0,0,0,1,0,0,0,1, 1,0,3,0,0,0,0,0,2,1, 1,0,4,0,0,0,0,0,0,1, 1,1,1,1,1,1,1,1,1,1],
            
            // Level 4: æ‹è§’é™·é˜± (3 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,2,0,0,0,0,0,0,1, 1,0,4,0,0,0,0,0,0,1, 1,0,0,1,1,1,1,1,0,1, 1,0,0,1,0,0,0,1,0,1, 1,0,4,1,0,0,0,1,0,1, 1,0,0,1,0,0,0,1,0,1, 1,3,0,1,0,0,0,0,0,1, 1,0,4,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1],

            // Level 5: ç‹­çª„é€šé“ (4 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,0,4,0,0,0,0,0,1, 1,2,1,0,1,0,1,0,0,1, 1,0,1,4,1,0,1,0,0,1, 1,0,1,0,1,0,1,0,0,1, 1,0,1,0,1,0,1,0,0,1, 1,0,1,4,1,0,1,0,0,1, 1,2,1,0,1,0,1,0,0,1, 1,3,0,4,0,0,0,0,0,1, 1,1,1,1,1,1,1,1,1,1],

            // Level 6: Lå½¢æ¨ (3 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,0,0,0,0,0,0,2,1,1, 1,0,4,1,1,1,0,0,0,1, 1,0,0,0,0,1,0,0,0,1, 1,1,1,1,0,1,0,4,0,1, 1,0,0,0,0,1,0,0,0,1, 1,0,4,0,0,1,1,1,0,1, 1,3,0,0,0,0,0,0,2,1, 1,0,0,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1],

            // Level 7: éœ€è¦åæ¨ (4 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,0,0,1,0,0,2,0,1, 1,0,1,0,1,0,0,0,0,1, 1,0,1,4,0,0,0,0,0,1, 1,0,1,0,1,0,0,0,0,1, 1,0,1,4,0,0,0,0,0,1, 1,0,1,0,1,0,0,0,0,1, 1,3,0,4,0,0,0,4,2,1, 1,0,0,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1],
            
            // Level 8: ç›®æ ‡è¢«å µä½ (3 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,0,0,0,0,0,0,0,0,1, 1,0,4,1,1,1,1,0,0,1, 1,0,0,0,0,0,1,0,0,1, 1,0,0,0,0,0,1,2,0,1, 1,0,0,0,0,0,1,2,0,1, 1,0,4,0,0,0,1,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,3,4,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1],
            
            // Level 9: å¤æ‚é€šé“ (4 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,0,0,1,0,0,0,0,1, 1,0,1,0,1,0,1,0,0,1, 1,0,1,4,0,4,1,0,0,1, 1,0,1,0,1,0,1,0,0,1, 1,0,1,0,1,0,1,0,0,1, 1,0,1,4,0,4,1,0,0,1, 1,0,1,0,1,0,1,0,2,1, 1,3,0,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1],

            // Level 10: æœ€ç»ˆè€ƒéªŒ (4 boxes)
            [1,1,1,1,1,1,1,1,1,1, 1,2,2,0,0,0,0,0,0,1, 1,0,0,0,1,4,1,0,0,1, 1,0,4,0,1,0,1,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,0,0,0,0,0,0,0,1, 1,0,4,0,1,0,1,0,0,1, 1,0,0,0,1,4,1,0,2,1, 1,3,0,0,0,0,0,0,2,1, 1,1,1,1,1,1,1,1,1,1]
        ];


        // --- åˆå§‹åŒ–å…³å¡ ---
        function loadLevel(index) {
            currentLevelIndex = index;
            const levelData = levels[index];
            boxes = [];
            targets = [];
            startPositions.boxes = [];
            mapLayout = [];
            moves = 0;
            
            for (let i = 0; i < levelData.length; i++) {
                const mapValue = levelData[i];
                const y = Math.floor(i / GRID_SIZE);
                const x = i % GRID_SIZE;

                if (mapValue === 3) {
                    startPositions.player = { x: x, y: y };
                    mapLayout.push(0); 
                } else if (mapValue === 4) {
                    startPositions.boxes.push({ x: x, y: y });
                    mapLayout.push(0); 
                } else if (mapValue === 2) {
                    targets.push({ x: x, y: y });
                    mapLayout.push(2); 
                } else {
                    mapLayout.push(mapValue); // å¢™å£(1)æˆ–åœ°æ¿(0)
                }
            }
            
            // å°†ç©å®¶å’Œç®±å­é‡ç½®åˆ°èµ·å§‹ç‚¹
            player = { ...startPositions.player };
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ·±æ‹·è´ï¼Œé˜²æ­¢æ•°ç»„å¼•ç”¨å¯¼è‡´é‡ç½®å¤±è´¥
            boxes = startPositions.boxes.map(box => ({ x: box.x, y: box.y })); 
            
            updateHUD();
        }

        // é‡ç½®å½“å‰å…³å¡çŠ¶æ€
        function resetLevel() {
            if (gameState === 'WIN') { // å¦‚æœåœ¨èƒœåˆ©ç•Œé¢ï¼Œåˆ™ä¸å“åº”Ré”®ï¼Œé¿å…å¹²æ‰°
                 return;
            }
            // ä½¿ç”¨å­˜å‚¨çš„èµ·å§‹ä½ç½®
            player = { ...startPositions.player };
            boxes = startPositions.boxes.map(box => ({ x: box.x, y: box.y }));
            moves = 0;
            gameState = 'PLAYING';
            updateHUD();
        }


        // -------------------------------------
        // æ¸¸æˆé€»è¾‘ï¼šç§»åŠ¨å’Œæ¨ç®±å­ (æ ¸å¿ƒé€»è¾‘)
        // -------------------------------------
        
        function getBoxIndex(x, y) {
            return boxes.findIndex(box => box.x === x && box.y === y);
        }
        
        function isPassable(x, y) {
             // è¾¹ç•Œæ£€æŸ¥
            if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return false;
            // åœ°å›¾æ•°æ®æ£€æŸ¥
            const index = y * GRID_SIZE + x;
            return mapLayout[index] !== 1; // 1 æ˜¯å¢™å£ï¼Œä¸å¯é€šè¿‡
        }

        // å¤„ç†ç©å®¶ç§»åŠ¨
        function movePlayer(dx, dy) {
            if (gameState !== 'PLAYING') return;

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (!isPassable(newX, newY)) {
                return; // æ’å¢™ï¼Œä¸åŠ¨
            }

            const boxIndex = getBoxIndex(newX, newY);
            
            if (boxIndex !== -1) {
                // ç¢°åˆ°ç®±å­ï¼Œå°è¯•æ¨åŠ¨
                const boxNewX = newX + dx;
                const boxNewY = newY + dy;

                // æ£€æŸ¥ç®±å­å‰é¢æ˜¯å¦å¯é€šè¡Œï¼ˆéå¢™å£ä¸”æ²¡æœ‰å…¶ä»–ç®±å­ï¼‰
                if (!isPassable(boxNewX, boxNewY) || getBoxIndex(boxNewX, boxNewY) !== -1) {
                    return; // æ¨åŠ¨å¤±è´¥
                }

                // æ¨åŠ¨æˆåŠŸ
                boxes[boxIndex].x = boxNewX;
                boxes[boxIndex].y = boxNewY;
            }
            
            // ç§»åŠ¨ç©å®¶
            player.x = newX;
            player.y = newY;
            moves++;
            updateHUD();

            // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
            checkWinCondition();
        }

        // æ£€æŸ¥èƒœåˆ©æ¡ä»¶ (ç¡®ä¿æ‰€æœ‰ç®±å­éƒ½åœ¨ç›®æ ‡ç‚¹ä¸Š)
        function checkWinCondition() {
            if (targets.length === 0) return;

            let allBoxesOnTarget = boxes.every(box => {
                return targets.some(target => target.x === box.x && target.y === box.y);
            });

            if (allBoxesOnTarget) {
                gameState = 'WIN';
                setTimeout(showWinScreen, 50); 
            }
        }
        
        // -------------------------------------
        // æ¸²æŸ“ã€HUD å’Œæµç¨‹æ§åˆ¶
        // -------------------------------------

        function draw() {
            ctx.fillStyle = '#455a64';
            ctx.fillRect(0, 0, GAME_SIZE, GAME_SIZE);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#37474f';
            for (let i = 0; i <= GRID_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(i * TILE_SIZE, 0);
                ctx.lineTo(i * TILE_SIZE, GAME_SIZE);
                ctx.moveTo(0, i * TILE_SIZE);
                ctx.lineTo(GAME_SIZE, i * TILE_SIZE);
                ctx.stroke();
            }

            // ç»˜åˆ¶åœ°å›¾å…ƒç´  (å¢™å£)
            for (let i = 0; i < mapLayout.length; i++) {
                const mapValue = mapLayout[i];
                if (mapValue === 1) { // å¢™å£
                    const y = Math.floor(i / GRID_SIZE);
                    const x = i % GRID_SIZE;
                    ctx.fillStyle = '#37474f';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }

            // ç»˜åˆ¶ç›®æ ‡ç‚¹
            targets.forEach(target => {
                ctx.fillStyle = 'rgba(255, 165, 0, 0.5)'; 
                ctx.beginPath();
                ctx.arc(target.x * TILE_SIZE + TILE_SIZE / 2, target.y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffeb3b'; 
                ctx.font = `${TILE_SIZE * 0.7}px monospace`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ¯', target.x * TILE_SIZE + TILE_SIZE / 2, target.y * TILE_SIZE + TILE_SIZE / 2);
            });

            // ç»˜åˆ¶ç®±å­
            boxes.forEach(box => {
                let isOnTarget = targets.some(target => target.x === box.x && target.y === box.y);
                
                ctx.fillStyle = isOnTarget ? '#00e676' : '#9e9e9e'; 
                ctx.fillRect(box.x * TILE_SIZE + 5, box.y * TILE_SIZE + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                
                ctx.fillStyle = '#000'; 
                ctx.font = `${TILE_SIZE * 0.6}px monospace`;
                ctx.fillText('ğŸ“¦', box.x * TILE_SIZE + TILE_SIZE / 2, box.y * TILE_SIZE + TILE_SIZE / 2);
            });
            
            // ç»˜åˆ¶ç©å®¶
            ctx.fillStyle = '#64b5f6'; 
            ctx.beginPath();
            ctx.arc(player.x * TILE_SIZE + TILE_SIZE / 2, player.y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 2 - 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#000'; 
            ctx.font = `${TILE_SIZE * 0.7}px monospace`;
            ctx.fillText('ğŸƒ', player.x * TILE_SIZE + TILE_SIZE / 2, player.y * TILE_SIZE + TILE_SIZE / 2);
        }

        function updateHUD() {
            document.getElementById('level-display').textContent = (currentLevelIndex + 1) + ' / ' + levels.length;
            document.getElementById('moves-display').textContent = moves;
        }

        function loop() {
            draw();
            requestAnimationFrame(loop);
        }

        function showWinScreen() {
            document.getElementById('info-panel').style.display = 'flex';
            
            let content;
            if (currentLevelIndex < levels.length - 1) {
                // è¿›å…¥ä¸‹ä¸€å…³
                content = `
                    <h1>æ­å–œé€šè¿‡ç¬¬ ${currentLevelIndex + 1} å…³!</h1>
                    <p>æ­¥æ•°: ${moves}</p>
                    <button id="next-level-button" class="control-button">è¿›å…¥ä¸‹ä¸€å…³</button>
                    <p class="hud-item"><a href="index.html" style="color: #64b5f6;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                `;
                document.getElementById('info-panel').innerHTML = content;
                // ç»‘å®šä¸‹ä¸€å…³æŒ‰é’®äº‹ä»¶
                document.getElementById('next-level-button').addEventListener('click', () => startGame(currentLevelIndex + 1));

            } else {
                // å…¨éƒ¨é€šå…³
                content = `
                    <h1>ğŸ‰ æ­å–œï¼æ‚¨æ˜¯è§£è°œå¤§å¸ˆï¼</h1>
                    <p>æ‰€æœ‰ ${levels.length} ä¸ªå…³å¡å®Œæˆï¼</p>
                    <button id="restart-button" class="control-button" onclick="startGame(0)">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
                    <p class="hud-item"><a href="index.html" style="color: #64b5f6;">è¿”å›æ¸¸æˆå¤§å…</a></p>
                `;
                document.getElementById('info-panel').innerHTML = content;
            }
        }
        
        function startGame(startLevelIndex = 0) {
            document.getElementById('info-panel').style.display = 'none';
            gameState = 'PLAYING';
            loadLevel(startLevelIndex);
        }
        
        // -------------------------------------
        // é”®ç›˜è¾“å…¥æ˜ å°„
        // -------------------------------------

        window.addEventListener('keydown', (e) => {
            if (gameState !== 'PLAYING') return;

            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼Œå¦‚é¡µé¢æ»šåŠ¨
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 's', 'a', 'd'].includes(e.key.toLowerCase())) {
                e.preventDefault();
            }

            let dx = 0;
            let dy = 0;

            switch (e.key.toLowerCase()) {
                case 'arrowup':
                case 'w':
                    dy = -1;
                    break;
                case 'arrowdown':
                case 's':
                    dy = 1;
                    break;
                case 'arrowleft':
                case 'a':
                    dx = -1;
                    break;
                case 'arrowright':
                case 'd':
                    dx = 1;
                    break;
                case 'r': // R é”®å¿«é€Ÿé‡ç½®
                    resetLevel();
                    return;
                default:
                    return;
            }

            if (dx !== 0 || dy !== 0) {
                movePlayer(dx, dy);
            }
        });

        // --- åˆå§‹åŒ– ---
        document.getElementById('start-button').addEventListener('click', () => startGame(0));
        loadLevel(0); // é¢„åŠ è½½ç¬¬ä¸€å…³åœ°å›¾
        loop();
    </script>

</body>
</html>
