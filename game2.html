<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé™…å°„å‡» - ä¸°å¯Œç‰ˆ</title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ï¼Œç¡®ä¿ç•Œé¢å…¼å®¹æ€§ */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #111;
            color: white;
            flex-direction: column;
            font-family: monospace, sans-serif;
        }
        #game-container {
            border: 3px solid #00f;
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.5);
            position: relative;
        }
        #game-canvas {
            display: block;
            background-color: #000;
        }
        #info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        #info-panel h1 {
            color: #00ff00;
            font-size: 3em;
        }
        #start-button, #restart-button {
            padding: 10px 30px;
            font-size: 1.5em;
            cursor: pointer;
            margin-top: 30px;
            background-color: #00f;
            color: white;
            border: 2px solid white;
            transition: background-color 0.3s;
        }
        #start-button:hover, #restart-button:hover {
            background-color: #00a;
        }
        .hud-item {
            margin-top: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <h1>ğŸš€ å¤æ‚æ˜Ÿé™…å°„å‡»</h1>

    <div id="game-container">
        <canvas id="game-canvas" width="600" height="800"></canvas>

        <div id="info-panel">
            <h1>æ˜Ÿé™…å°„å‡» V2.0</h1>
            <p>æ“ä½œï¼šæ–¹å‘é”®/AD ç§»åŠ¨ï¼Œç©ºæ ¼/W å°„å‡»ã€‚</p>
            <p><strong>æ–°ç‰¹æ€§ï¼š</strong> è§†å·®èƒŒæ™¯ã€åŒå‘é“å…·ã€å¤šç§æ•Œäººï¼</p>
            <button id="start-button">å¼€å§‹æ¿€çƒˆæˆ˜æ–—</button>
            <p class="hud-item"><a href="index.html" style="color: #00f;">è¿”å›æ¸¸æˆå¤§å…</a></p>
        </div>
    </div>

    <div class="hud-item">
        å¾—åˆ†: <span id="score-display">0</span> | ç”Ÿå‘½: <span id="life-display">3</span> | ç«åŠ›: <span id="power-display">å•å‘</span>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;

        let gameState = 'START';
        let score = 0;
        let lives = 3;

        // --- ç©å®¶é£èˆ¹ ---
        let player = {
            x: GAME_WIDTH / 2 - 20,
            y: GAME_HEIGHT - 60,
            width: 40,
            height: 40,
            speed: 7, // åŠ å¿«é€Ÿåº¦
            powerUp: 'single', // 'single' æˆ– 'double'
            powerUpTimer: 0
        };

        // --- æ¸¸æˆå…ƒç´ æ•°ç»„ ---
        let bullets = [];
        let enemies = [];
        let powerups = []; // é“å…·æ•°ç»„
        let enemySpawnInterval = 1200;
        let lastSpawnTime = 0;

        // --- è§†å·®èƒŒæ™¯ï¼ˆParallax Backgroundï¼‰ ---
        const stars = [
            { speed: 0.5, size: 1, color: '#444', count: 50 },
            { speed: 1.5, size: 2, color: '#777', count: 30 },
            { speed: 3.0, size: 3, color: '#AAA', count: 10 }
        ];
        // åˆå§‹åŒ–æ˜Ÿç‚¹ä½ç½®
        stars.forEach(layer => {
            layer.points = [];
            for (let i = 0; i < layer.count; i++) {
                layer.points.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT
                });
            }
        });

        // --- è¾“å…¥å¤„ç† ---
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if ((e.key === ' ' || e.key === 'w') && gameState === 'PLAYING') {
                e.preventDefault();
            }
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        // -------------------------------------
        // æ¸¸æˆå¯¹è±¡ç±»
        // -------------------------------------

        class Bullet {
            constructor(x, y, offset = 0) {
                this.x = x + offset;
                this.y = y;
                this.width = 4;
                this.height = 10;
                this.speed = 15;
                this.color = '#ff0';
                this.damage = 1;
            }
            update() {
                this.y -= this.speed;
            }
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        class Enemy {
            constructor(type) {
                this.type = type;
                this.speed = 2 + Math.random() * 1.5;
                this.width = (type === 'tank') ? 50 : 30;
                this.height = (type === 'tank') ? 50 : 30;
                this.x = Math.random() * (GAME_WIDTH - this.width);
                this.y = -this.height;
                this.maxHealth = (type === 'tank') ? 3 : 1; // å¦å…‹è¡€é‡æ›´é«˜
                this.health = this.maxHealth;
                this.color = (type === 'tank') ? '#900' : '#f00'; // çº¢è‰²å’Œæ·±çº¢è‰²

                // æ‘‡æ‘†è¿åŠ¨å‚æ•° (ç”¨äº 'scout' ä¾¦å¯Ÿæœº)
                this.baseX = this.x;
                this.angle = Math.random() * Math.PI * 2;
                this.amplitude = (type === 'scout') ? 30 : 0; // æ‘‡æ‘†å¹…åº¦
                this.frequency = (type === 'scout') ? 0.05 : 0; // æ‘‡æ‘†é¢‘ç‡
            }
            update() {
                this.y += this.speed;
                if (this.type === 'scout') {
                    this.angle += this.frequency;
                    this.x = this.baseX + this.amplitude * Math.sin(this.angle);
                }
            }
            draw(ctx) {
                // ç»˜åˆ¶å½¢çŠ¶ (ç®€åŒ–)
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);

                // ç»˜åˆ¶è¡€æ¡ (å¦‚æœè¡€é‡ä½äºæ»¡è¡€)
                if (this.health < this.maxHealth) {
                    const healthBarWidth = this.width * (this.health / this.maxHealth);
                    ctx.fillStyle = 'lime';
                    ctx.fillRect(this.x, this.y - 5, healthBarWidth, 3);
                }
            }
        }

        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.type = type; // 'double' æˆ– 'life'
                this.color = (type === 'double') ? 'cyan' : 'orange';
                this.speed = 3;
            }
            update() {
                this.y += this.speed;
            }
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = 'black';
                ctx.font = '12px monospace';
                ctx.fillText(this.type === 'double' ? 'X2' : '+L', this.x + 2, this.y + 14);
            }
        }

        // -------------------------------------
        // æ ¸å¿ƒæ¸¸æˆå¾ªç¯
        // -------------------------------------

        let lastShotTime = 0;
        const shotDelay = 150; 

        function drawParallaxBackground(delta) {
            stars.forEach(layer => {
                ctx.fillStyle = layer.color;
                layer.points.forEach(p => {
                    // æ›´æ–°Yä½ç½®å¹¶å¾ªç¯
                    p.y += layer.speed;
                    if (p.y > GAME_HEIGHT) {
                        p.y = 0;
                        p.x = Math.random() * GAME_WIDTH;
                    }
                    ctx.fillRect(p.x, p.y, layer.size, layer.size);
                });
            });
        }

        function handleInput() {
            // å·¦å³ç§»åŠ¨
            if (keys['arrowleft'] || keys['a']) {
                player.x -= player.speed;
            }
            if (keys['arrowright'] || keys['d']) {
                player.x += player.speed;
            }

            // è¾¹ç•Œé™åˆ¶
            if (player.x < 0) player.x = 0;
            if (player.x > GAME_WIDTH - player.width) player.x = GAME_WIDTH - player.width;

            // å°„å‡»
            if ((keys[' '] || keys['w']) && Date.now() - lastShotTime > shotDelay) {
                if (player.powerUp === 'double') {
                    // åŒå‘å­å¼¹
                    bullets.push(new Bullet(player.x + player.width / 2, player.y, -player.width / 4));
                    bullets.push(new Bullet(player.x + player.width / 2, player.y, player.width / 4));
                } else {
                    // å•å‘å­å¼¹
                    bullets.push(new Bullet(player.x + player.width / 2 - 2, player.y));
                }
                
                lastShotTime = Date.now();
                // æ’­æ”¾å°„å‡»éŸ³æ•ˆ (å¦‚æœå°†æ¥é›†æˆ)
                // playSound('shoot'); 
            }
        }

        function spawnEnemies() {
            if (Date.now() - lastSpawnTime > enemySpawnInterval) {
                // éšæœºå†³å®šæ•Œäººç±»å‹
                let enemyType;
                const r = Math.random();
                if (r < 0.6) {
                    enemyType = 'default';
                } else if (r < 0.85) {
                    enemyType = 'scout'; // æ‘‡æ‘†æ•Œäºº
                } else {
                    enemyType = 'tank'; // é«˜è¡€é‡æ•Œäºº
                }
                enemies.push(new Enemy(enemyType));
                lastSpawnTime = Date.now();
                // éšç€æ—¶é—´æ¨è¿›ï¼ŒåŠ å¿«ç”Ÿæˆé€Ÿåº¦ï¼ˆæœ€å° 200msï¼‰
                enemySpawnInterval = Math.max(200, enemySpawnInterval * 0.97); 
            }
        }

        function checkCollisions() {
            // --- å­å¼¹å’Œæ•Œäººç¢°æ’ ---
            for (let i = 0; i < bullets.length; i++) {
                for (let j = 0; j < enemies.length; j++) {
                    const b = bullets[i];
                    const e = enemies[j];

                    if (checkAABB(b, e)) {
                        bullets.splice(i, 1);
                        e.health -= b.damage;
                        i--; // è°ƒæ•´å­å¼¹ç´¢å¼•

                        if (e.health <= 0) {
                            // çˆ†ç‚¸è§†è§‰æ•ˆæœ (å¦‚æœå°†æ¥é›†æˆ)
                            // addExplosion(e.x, e.y);
                            score += e.maxHealth * 10; // æ ¹æ®æ•Œäººå¼ºåº¦ç»™åˆ†
                            
                            // éšæœºæ‰è½é“å…·
                            if (Math.random() < 0.2) { // 20% æ¦‚ç‡æ‰è½
                                const type = (Math.random() < 0.7) ? 'double' : 'life';
                                powerups.push(new PowerUp(e.x + e.width / 2, e.y, type));
                            }

                            enemies.splice(j, 1);
                            j--; // è°ƒæ•´æ•Œäººç´¢å¼•
                        }
                        break;
                    }
                }
            }

            // --- ç©å®¶å’Œæ•Œäººç¢°æ’ ---
            for (let i = 0; i < enemies.length; i++) {
                const e = enemies[i];
                if (checkAABB(player, e)) {
                    enemies.splice(i, 1);
                    lives--;
                    i--;

                    if (lives <= 0) {
                        gameState = 'GAMEOVER';
                        // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ (å¦‚æœå°†æ¥é›†æˆ)
                        // playSound('explosion');
                        showEndScreen();
                    }
                }
            }

            // --- ç©å®¶å’Œé“å…·ç¢°æ’ ---
            for (let i = 0; i < powerups.length; i++) {
                const p = powerups[i];
                if (checkAABB(player, p)) {
                    if (p.type === 'double') {
                        player.powerUp = 'double';
                        player.powerUpTimer = 300; // æŒç»­ 300 å¸§ (çº¦ 5 ç§’)
                    } else if (p.type === 'life' && lives < 5) { // æœ€å¤š 5 æ¡å‘½
                        lives++;
                    }
                    powerups.splice(i, 1);
                    i--;
                }
            }
        }
        
        // AABB ç¢°æ’æ£€æµ‹
        function checkAABB(objA, objB) {
            return (
                objA.x < objB.x + objB.width &&
                objA.x + objA.width > objB.x &&
                objA.y < objB.y + objB.height &&
                objA.y + objA.height > objB.y
            );
        }


        function update() {
            if (gameState !== 'PLAYING') return;

            // é“å…·è®¡æ—¶å™¨
            if (player.powerUp === 'double' && player.powerUpTimer > 0) {
                player.powerUpTimer--;
                if (player.powerUpTimer === 0) {
                    player.powerUp = 'single';
                }
            }

            handleInput();
            spawnEnemies();

            // æ›´æ–°æ‰€æœ‰å¯¹è±¡ä½ç½®
            bullets.forEach(b => b.update());
            enemies.forEach(e => e.update());
            powerups.forEach(p => p.update());

            // è¿‡æ»¤å’Œè¾¹ç•Œæ£€æŸ¥
            bullets = bullets.filter(b => b.y > -b.height);
            enemies = enemies.filter(e => e.y <= GAME_HEIGHT);
            powerups = powerups.filter(p => p.y <= GAME_HEIGHT);
            
            // æ•Œäººè·‘æ‰ä¹Ÿæ‰£è¡€
            enemies.filter(e => e.y > GAME_HEIGHT).forEach(() => {
                lives--;
                if (lives <= 0) {
                    gameState = 'GAMEOVER';
                    showEndScreen();
                }
            });

            checkCollisions();
            updateHUD();
        }

        function draw() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            // ç»˜åˆ¶è§†å·®èƒŒæ™¯
            drawParallaxBackground();

            // ç»˜åˆ¶ç©å®¶ (é£èˆ¹)
            ctx.fillStyle = (player.powerUp === 'double') ? '#0ff' : '#0f0'; // åŒå‘æ—¶å˜è‰²
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // ç»˜åˆ¶å­å¼¹
            bullets.forEach(b => b.draw(ctx));

            // ç»˜åˆ¶æ•Œäºº
            enemies.forEach(e => e.draw(ctx));

            // ç»˜åˆ¶é“å…·
            powerups.forEach(p => p.draw(ctx));
        }

        function updateHUD() {
            document.getElementById('score-display').textContent = score;
            document.getElementById('life-display').textContent = lives;
            document.getElementById('power-display').textContent = 
                (player.powerUp === 'double') ? `åŒå‘ (${Math.ceil(player.powerUpTimer / 60)}s)` : 'å•å‘';
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function startGame() {
            document.getElementById('info-panel').style.display = 'none';
            gameState = 'PLAYING';
            // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€
            score = 0;
            lives = 3;
            player.x = GAME_WIDTH / 2 - 20;
            player.powerUp = 'single';
            player.powerUpTimer = 0;
            bullets = [];
            enemies = [];
            powerups = [];
            enemySpawnInterval = 1200;
            lastSpawnTime = 0;
            lastShotTime = 0;
            updateHUD();
        }

        function showEndScreen() {
            document.getElementById('info-panel').style.display = 'flex';
            // é‡æ–°å¼€å§‹æŒ‰é’®ä½¿ç”¨ resetGame å‡½æ•°ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ
            document.getElementById('info-panel').innerHTML = `
                <h1>æ¸¸æˆç»“æŸ!</h1>
                <p>æœ€ç»ˆå¾—åˆ†: ${score}</p>
                <button id="restart-button" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                <p class="hud-item"><a href="index.html" style="color: #00f;">è¿”å›æ¸¸æˆå¤§å…</a></p>
            `;
        }

        function resetGame() {
            // é‡æ–°å¼€å§‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç›´æ¥è°ƒç”¨ startGameï¼Œé‡ç½®å¹¶è¿›å…¥ PLAYING çŠ¶æ€
            startGame(); 
        }

        // --- åˆå§‹åŒ– ---
        document.getElementById('start-button').addEventListener('click', startGame);
        // ç¡®ä¿ä¸€å¼€å§‹å°±æ¸²æŸ“èƒŒæ™¯å’Œç©å®¶
        draw(); 
        // å¯åŠ¨æ¸¸æˆå¾ªç¯
        loop();
    </script>

</body>
</html>
